"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.withModuleFederation = void 0;
const utils_1 = require("./utils");
const ModuleFederationPlugin = require("webpack/lib/container/ModuleFederationPlugin");
/**
 * @param {ModuleFederationConfig} options
 * @return {Promise<AsyncNxWebpackPlugin>}
 */
async function withModuleFederation(options) {
    const { sharedDependencies, sharedLibraries, mappedRemotes } = await (0, utils_1.getModuleFederationConfig)(options);
    return (config, ctx) => {
        config.output.uniqueName = options.name;
        config.output.publicPath = 'auto';
        config.optimization = {
            runtimeChunk: false,
        };
        config.experiments = {
            ...config.experiments,
            outputModule: true,
        };
        config.plugins.push(new ModuleFederationPlugin({
            name: options.name,
            library: options.library ?? { type: 'module' },
            filename: 'remoteEntry.js',
            exposes: options.exposes,
            remotes: mappedRemotes,
            shared: {
                ...sharedDependencies,
            },
        }), sharedLibraries.getReplacementPlugin());
        return config;
    };
}
exports.withModuleFederation = withModuleFederation;
